<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Simple - Scrim Finder</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            line-height: 1.6;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #007bff;
            background: #2d2d2d;
        }
        .error { border-left-color: #dc3545; background: #2d1f1f; }
        .success { border-left-color: #28a745; background: #1f2d1f; }
        .warning { border-left-color: #ffc107; background: #2d2a1f; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { background: #000; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test Simple Scrim Finder</h1>
    
    <div id="status-container">
        <div class="status" id="status-auth">‚ùì Authentification: En cours...</div>
        <div class="status" id="status-supabase">‚ùì Supabase: En cours...</div>
        <div class="status" id="status-team">‚ùì √âquipe: En attente auth...</div>
        <div class="status" id="status-scrims">‚ùì Scrims: En attente √©quipe...</div>
    </div>
    
    <div style="margin: 20px 0;">
        <button onclick="testCreateScrim()">üéÆ Cr√©er un scrim de test</button>
        <button onclick="testSearchScrims()">üîç Rechercher scrims</button>
        <button onclick="clearLogs()">üßπ Effacer logs</button>
    </div>
    
    <div id="logs"></div>

    <!-- Import Supabase -->
    <script src="JS/supabase-config.js"></script>
    
    <script>
        let currentUser = null;
        let currentTeam = null;
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            updateLogsDisplay();
            console.log(message);
        }
        
        function updateLogsDisplay() {
            const logsContainer = document.getElementById('logs');
            logsContainer.innerHTML = '<h3>üìã Logs:</h3><pre>' + logs.slice(-20).join('\n') + '</pre>';
        }
        
        function clearLogs() {
            logs = [];
            updateLogsDisplay();
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ùì' };
                element.textContent = `${icons[type]} ${message}`;
                element.className = `status ${type}`;
            }
        }
        
        async function initializeApp() {
            log('üöÄ D√©marrage de l\'application');
            
            try {
                // Test 1: Wait for Supabase to load
                log('‚è≥ Attente du chargement de Supabase...');
                
                // Wait up to 10 seconds for Supabase to load
                let attempts = 0;
                const maxAttempts = 50; // 50 * 200ms = 10 seconds
                
                while (!window.supabaseClient && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }
                
                if (!window.supabaseClient) {
                    updateStatus('status-supabase', 'Supabase: Timeout de chargement', 'error');
                    log('‚ùå Timeout: Supabase client non disponible apr√®s 10s');
                    return;
                }
                
                updateStatus('status-supabase', 'Supabase: Connect√©', 'success');
                log('‚úÖ Supabase client disponible');
                
                // Test 2: Auth
                const { data: { user }, error: authError } = await window.supabaseClient.auth.getUser();
                
                if (authError || !user) {
                    updateStatus('status-auth', 'Auth: Non connect√©', 'error');
                    log('‚ùå Utilisateur non connect√©');
                    log('Redirection vers la page de connexion...');
                    setTimeout(() => {
                        window.location.href = '../HTML/login.html';
                    }, 2000);
                    return;
                }
                
                currentUser = user;
                updateStatus('status-auth', `Auth: ${user.email}`, 'success');
                log(`‚úÖ Utilisateur connect√©: ${user.email}`);
                
                // Test 3: √âquipes
                await loadTeam();
                
                // Test 4: Scrims
                if (currentTeam) {
                    await testScrims();
                }
                
            } catch (error) {
                log(`‚ùå Erreur d'initialisation: ${error.message}`);
                updateStatus('status-auth', 'Erreur d\'initialisation', 'error');
            }
        }
        
        async function loadTeam() {
            try {
                log("üîç Recherche d'√©quipes...");
                
                // Chercher les √©quipes cr√©√©es par l'utilisateur
                const { data: ownedTeams, error: ownedError } = await window.supabaseClient
                    .from('teams')
                    .select('*')
                    .eq('created_by', currentUser.id)
                    .limit(1);
                    
                if (ownedError) {
                    log(`‚ùå Erreur √©quipes owned: ${ownedError.message}`);
                    throw ownedError;
                }
                
                log(`√âquipes trouv√©es (owned): ${ownedTeams?.length || 0}`);
                
                if (ownedTeams && ownedTeams.length > 0) {
                    currentTeam = ownedTeams[0];
                    updateStatus('status-team', `√âquipe: ${currentTeam.name} (${currentTeam.game})`, 'success');
                    log(`‚úÖ √âquipe charg√©e: ${currentTeam.name} - ${currentTeam.game}`);
                } else {
                    // Chercher dans team_members si pas d'√©quipe owned
                    const { data: memberTeams, error: memberError } = await window.supabaseClient
                        .from('team_members')
                        .select('teams(*)')
                        .eq('user_id', currentUser.id)
                        .limit(1);
                        
                    if (memberError) {
                        log(`‚ö†Ô∏è Erreur team_members: ${memberError.message}`);
                    }
                    
                    if (memberTeams && memberTeams.length > 0 && memberTeams[0].teams) {
                        currentTeam = memberTeams[0].teams;
                        updateStatus('status-team', `√âquipe: ${currentTeam.name} (membre)`, 'success');
                        log(`‚úÖ √âquipe trouv√©e (membre): ${currentTeam.name}`);
                    } else {
                        updateStatus('status-team', '√âquipe: Aucune √©quipe trouv√©e', 'warning');
                        log('‚ö†Ô∏è Aucune √©quipe trouv√©e - vous devez cr√©er une √©quipe');
                    }
                }
                
            } catch (error) {
                updateStatus('status-team', `√âquipe: Erreur - ${error.message}`, 'error');
                log(`‚ùå Erreur lors du chargement de l'√©quipe: ${error.message}`);
            }
        }
        
        async function testScrims() {
            try {
                log('üîç Test des scrims...');
                
                // Test simple: compter tous les scrims
                const { data: allScrims, error: allError } = await window.supabaseClient
                    .from('scrims')
                    .select('id, status, team_id, scrim_date')
                    .limit(10);
                    
                if (allError) {
                    log(`‚ùå Erreur scrims: ${allError.message}`);
                    updateStatus('status-scrims', 'Scrims: Erreur DB', 'error');
                    return;
                }
                
                log(`Total scrims dans la DB: ${allScrims?.length || 0}`);
                
                // Test scrims de l'√©quipe
                if (currentTeam) {
                    const { data: teamScrims, error: teamError } = await window.supabaseClient
                        .from('scrims')
                        .select('*')
                        .eq('team_id', currentTeam.id);
                        
                    if (teamError) {
                        log(`‚ùå Erreur scrims √©quipe: ${teamError.message}`);
                    } else {
                        log(`Scrims de votre √©quipe: ${teamScrims?.length || 0}`);
                        
                        if (teamScrims && teamScrims.length > 0) {
                            teamScrims.forEach(scrim => {
                                log(`  - ID: ${scrim.id}, Status: ${scrim.status}, Date: ${scrim.scrim_date}`);
                            });
                        }
                    }
                    
                    // Test scrims pending des autres √©quipes
                    const { data: pendingScrims, error: pendingError } = await window.supabaseClient
                        .from('scrims')
                        .select('id, status, team_id')
                        .eq('status', 'pending')
                        .neq('team_id', currentTeam.id);
                        
                    if (pendingError) {
                        log(`‚ùå Erreur scrims pending: ${pendingError.message}`);
                    } else {
                        log(`Scrims pending d'autres √©quipes: ${pendingScrims?.length || 0}`);
                        updateStatus('status-scrims', `Scrims: ${allScrims?.length || 0} total, ${pendingScrims?.length || 0} disponibles`, 'success');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erreur test scrims: ${error.message}`);
                updateStatus('status-scrims', 'Scrims: Erreur test', 'error');
            }
        }
        
        async function testCreateScrim() {
            if (!currentTeam) {
                log('‚ùå Impossible de cr√©er un scrim sans √©quipe');
                return;
            }
            
            try {
                log("üéÆ Cr√©ation d'un scrim de test...");
                
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateStr = tomorrow.toISOString().split('T')[0];
                
                const scrimData = {
                    team_id: currentTeam.id,
                    game: currentTeam.game || 'lol',
                    title: `Test Scrim - ${currentTeam.name}`,
                    opponent_name: 'Recherche adversaire',
                    scrim_date: dateStr,
                    scrim_time: '20:00:00',
                    format: 'bo1',
                    final_score: '0-0',
                    matches: [],
                    notes: `Scrim de test cr√©√© le ${new Date().toLocaleString()}`,
                    status: 'pending',
                    created_by: currentUser.id
                };
                
                const { data: newScrim, error: scrimError } = await window.supabaseClient
                    .from('scrims')
                    .insert([scrimData])
                    .select()
                    .single();
                    
                if (scrimError) {
                    log(`‚ùå Erreur cr√©ation scrim: ${scrimError.message}`);
                    log(`Code: ${scrimError.code}, D√©tails: ${scrimError.details}`);
                    return;
                }
                
                log(`‚úÖ Scrim cr√©√© avec succ√®s! ID: ${newScrim.id}`);
                await testScrims(); // Refresh
                
            } catch (error) {
                log(`‚ùå Exception cr√©ation scrim: ${error.message}`);
            }
        }
        
        async function testSearchScrims() {
            if (!currentTeam) {
                log('‚ùå Impossible de rechercher sans √©quipe');
                return;
            }
            
            try {
                log('üîç Test de recherche de scrims...');
                
                // Requ√™te pour TOUS les scrims pending (y compris les n√¥tres)
                const { data: scrims, error } = await window.supabaseClient
                    .from('scrims')
                    .select('*')
                    .eq('status', 'pending')
                    .gte('scrim_date', new Date().toISOString().split('T')[0])
                    .order('scrim_date', { ascending: true });
                    
                if (error) {
                    log(`‚ùå Erreur recherche: ${error.message}`);
                    log(`Code: ${error.code}, D√©tails: ${error.details}`);
                    return;
                }
                
                log(`Scrims trouv√©s: ${scrims?.length || 0}`);
                
                if (scrims && scrims.length > 0) {
                    scrims.forEach(scrim => {
                        const isOwnScrim = scrim.team_id === currentTeam.id;
                        const prefix = isOwnScrim ? 'üü¢ [VOS]' : 'üîµ [AUTRE]';
                        log(`  ${prefix} ID: ${scrim.id}, Date: ${scrim.scrim_date} ${scrim.scrim_time}`);
                    });
                    
                    const ownScrims = scrims.filter(s => s.team_id === currentTeam.id);
                    const otherScrims = scrims.filter(s => s.team_id !== currentTeam.id);
                    log(`üìä R√©sum√©: ${ownScrims.length} vos scrims, ${otherScrims.length} scrims d'autres √©quipes`);
                } else {
                    log('Aucun scrim disponible trouv√©');
                }
                
            } catch (error) {
                log(`‚ùå Exception recherche: ${error.message}`);
            }
        }
        
        // D√©marrage
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>